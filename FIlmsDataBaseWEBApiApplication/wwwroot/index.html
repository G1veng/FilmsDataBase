<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Зая</title>
    <script src="jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="StyleSheet.css" />
</head>
<body>
    <div>
        <form method="post" action="Home" enctype="multipart/form-data">
            <input type="text" name="title" placeholder="Title..."/>
            <input type="file" name="icon" placeholder="Icon..."/>
            <input type="file" name="trailer" placeholder="Trailer..." />
            <input type="datetime" name="year" placeholder="Year..." />
            <input type="text" name="description" placeholder="Description..."/>
            <input type="submit" />
        </form>
        <img src="Files/Images/BlueSmile.jpg" height="100" width="150"/>
        <video height="200" width="350" controls>
            <source src="Files/Media/SPIDER-MAN_ NO WAY HOME - Official Trailer (HD).mp4" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'/>
        </video>
        <button id="saveFilm">Sent</button>
    </div>
    <div class="films" id="films">
        <img />
    </div>
    <script type="text/javascript" lang="en">
        $(document).ready(function () {
            GetAllFilms();
            console.log("Came");
        });
        async function postFormDataAsJson({ url, formData }) {
            const plainFormData = Object.fromEntries(formData.entries());
            const formDataJsonString = JSON.stringify(plainFormData);

            const fetchOptions = {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Accept: "application/json",
                },
                body: formDataJsonString,
            };

            const response = await fetch(url, fetchOptions);

            if (!response.ok) {
                const errorMessage = await response.text();
                throw new Error(errorMessage);
            }

            return response.json();
        }
        function getUserChoice() {
            var user_sol = document.getElementById("sol").value;
            console.log(user_sol);
        }
        async function handleFormSubmit(event) {
            event.preventDefault();

            const form = event.currentTarget;
            const url = form.action;

            try {
                const formData = new FormData(form);
                const responseData = await postFormDataAsJson({ url, formData });

                console.log({ responseData });
            } catch (error) {
                console.error(error);
            }
        }
        function SendAll() {
            console.log(Collect());

            $.ajax({
                url: 'home',
                type: 'POST',
                data: JSON.stringify(Collect()),
                contentType: "application/json;charset=utf-8",
            });
        }
        function Collect() {
            var book = {
                title: GetTitle(),
                description: GetDescription(),
                //icon: document.getElementById('icon').value,
                icon: document.getElementById('icon').value,
                trailer: GetTrailer(),
                year: GetYear()
            }
            return book;
        }
        function GetAllFilms() {
            $("#films").empty();
            $.getJSON({
                url: "film",
                type: 'GET',
                dataType: 'JSON',
                success: function (data) {
                    ShowFilms(JSON.parse(data));
                },
                error: function (data) {
                    console.log(data);
                    ShowFilms(data);
                }
            });
        }
        function ShowFilms(books) {
            console.log("came two");
            $(books).each(function (index, book) {
                var htmlString = "<label>Id: " + book.id + "</label><label>Title: "
                    + book.title + "</label><label>Description: " + book.description + "</label><img=" + book.icon + "/><label>Trailer: "
                    + book.trailer + "</label><br/><label>Year: " + book.year + "</label>";
                $('.films').append(htmlString);
                console.log(book);
            });
        }
        function AddFilm() {
            if (WriteOffFilm() == null)
                return;
            console.log(WriteOffFilm());
            $.ajax({
                url: 'api/home',
                type: 'POST',
                data: JSON.stringify(WriteOffFilm()),
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    GetAllFilms();
                },

            });
        }
        function DeleteFilm() {
            $.ajax({
                url: 'home/' + GetIdentificationNumber(),
                type: 'DELETE',
                success: function (data) {
                    GetAllFilms();
                },
                error: function (data) {
                    alert("Error");
                    console.log(data);
                }
            });
        }
        function EditFilm() {
            $.ajax({
                url: 'home/' + GetIdentificationNumber(),
                type: 'PUT',
                data: JSON.stringify(WriteOffFilmWithId()),
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    GetAllFilms();
                },
                error: function (data) {
                    GetAllFilms();
                }
            });
        }
        function GetIdentificationNumber() {
            let identificationNumberArea = document.getElementById("identificationNumber");
            return identificationNumberArea.value;
        }
        function GetTitle() {
            let titleArea = document.getElementById("title");
            return titleArea.value;
        }
        function GetDescription() {
            let descriptionArea = document.getElementById("description");
            return descriptionArea.value;
        }
        function GetTrailer() {
            let trailerArea = document.getElementById("description");
            return trailerArea.value;
        }
        function GetTrailer() {
            let iconArea = document.getElementById("icon");
            return iconArea;
        }
        function GetYear() {
            let yearArea = document.getElementById("year");
            return yearArea.value;
        }
        function GetIcon() {
            let iconArea = document.getElementById("icon");
            return iconArea;
        }
        function WriteOffFilm() {
            var book = {
                title: GetTitle(),
                description: GetDescription(),
                icon: GetIcon(),
                trailer: GetTrailer(),
                year: GetYear()
            }
            return book;
        }
        function WriteOffFilmWithId() {
            var book = {
                id: GetIdentificationNumber(),
                title: GetTitle(),
                description: GetDescription(),
                icon: GetIcon(),
                trailer: GetTrailer(),
                year: GetYear()
            }
            return book;
        }
    </script>
</body>
</html>
